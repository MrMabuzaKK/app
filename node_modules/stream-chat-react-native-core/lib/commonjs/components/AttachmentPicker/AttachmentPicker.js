var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AttachmentPicker = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _react = _interopRequireWildcard(require("react"));

var _reactNative = require("react-native");

var _bottomSheet = _interopRequireWildcard(require("@gorhom/bottom-sheet"));

var _dayjs = _interopRequireDefault(require("dayjs"));

var _duration = _interopRequireDefault(require("dayjs/plugin/duration"));

var _mimeTypes = require("mime-types");

var _AttachmentPickerContext = require("../../contexts/attachmentPickerContext/AttachmentPickerContext");

var _ThemeContext = require("../../contexts/themeContext/ThemeContext");

var _icons = require("../../icons");

var _native = require("../../native");

var _utils = require("../../utils/utils");

var _this = this,
    _jsxFileName = "/home/runner/work/stream-chat-react-native/stream-chat-react-native/package/src/components/AttachmentPicker/AttachmentPicker.tsx";

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

_dayjs["default"].extend(_duration["default"]);

var styles = _reactNative.StyleSheet.create({
  container: {
    flexGrow: 1
  },
  durationText: {
    fontWeight: 'bold'
  },
  overlay: {
    alignItems: 'flex-end',
    flex: 1
  },
  videoView: {
    bottom: 5,
    display: 'flex',
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingHorizontal: 5,
    position: 'absolute',
    width: '100%'
  }
});

var screenHeight = (0, _utils.vh)(100);

var fullScreenHeight = _reactNative.Dimensions.get('window').height;

var AttachmentVideo = function AttachmentVideo(props) {
  var asset = props.asset,
      ImageOverlaySelectedComponent = props.ImageOverlaySelectedComponent,
      maxNumberOfFiles = props.maxNumberOfFiles,
      numberOfAttachmentPickerImageColumns = props.numberOfAttachmentPickerImageColumns,
      numberOfUploads = props.numberOfUploads,
      selected = props.selected,
      setSelectedFiles = props.setSelectedFiles;

  var _useTheme = (0, _ThemeContext.useTheme)(),
      _useTheme$theme = _useTheme.theme,
      _useTheme$theme$attac = _useTheme$theme.attachmentPicker,
      durationText = _useTheme$theme$attac.durationText,
      image = _useTheme$theme$attac.image,
      imageOverlay = _useTheme$theme$attac.imageOverlay,
      _useTheme$theme$color = _useTheme$theme.colors,
      overlay = _useTheme$theme$color.overlay,
      white = _useTheme$theme$color.white;

  var duration = asset.duration,
      playableDuration = asset.playableDuration,
      uri = asset.uri;
  var videoDuration = duration ? duration : playableDuration;
  var ONE_HOUR_IN_SECONDS = 3600;
  var durationLabel = '00:00';

  if (videoDuration) {
    var isDurationLongerThanHour = videoDuration / ONE_HOUR_IN_SECONDS >= 1;
    var formattedDurationParam = isDurationLongerThanHour ? 'HH:mm:ss' : 'mm:ss';

    var formattedVideoDuration = _dayjs["default"].duration(videoDuration, 'second').format(formattedDurationParam);

    durationLabel = formattedVideoDuration;
  }

  var size = (0, _utils.vw)(100) / (numberOfAttachmentPickerImageColumns || 3) - 2;

  var onPressVideo = function () {
    var _ref = (0, _asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee() {
      var localAssetURI;
      return _regenerator["default"].wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              _context.t0 = asset.id;

              if (!_context.t0) {
                _context.next = 5;
                break;
              }

              _context.next = 4;
              return (0, _native.getLocalAssetUri)(asset.id);

            case 4:
              _context.t0 = _context.sent;

            case 5:
              localAssetURI = _context.t0;

              if (selected) {
                setSelectedFiles(function (files) {
                  return files.filter(function (file) {
                    return file.uri !== asset.uri;
                  });
                });
              } else {
                setSelectedFiles(function (files) {
                  if (numberOfUploads >= maxNumberOfFiles) {
                    _reactNative.Alert.alert('Maximum number of files reached');

                    return files;
                  }

                  return [].concat((0, _toConsumableArray2["default"])(files), [{
                    duration: durationLabel,
                    name: asset.filename,
                    size: asset.fileSize,
                    type: 'video',
                    uri: localAssetURI || asset.uri
                  }]);
                });
              }

            case 7:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    }));

    return function onPressVideo() {
      return _ref.apply(this, arguments);
    };
  }();

  return _react["default"].createElement(_bottomSheet.TouchableOpacity, {
    onPress: onPressVideo,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 138,
      columnNumber: 5
    }
  }, _react["default"].createElement(_reactNative.ImageBackground, {
    source: {
      uri: uri
    },
    style: [{
      height: size,
      margin: 1,
      width: size
    }, image],
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 139,
      columnNumber: 7
    }
  }, selected && _react["default"].createElement(_reactNative.View, {
    style: [styles.overlay, {
      backgroundColor: overlay
    }, imageOverlay],
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 151,
      columnNumber: 11
    }
  }, _react["default"].createElement(ImageOverlaySelectedComponent, {
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 152,
      columnNumber: 13
    }
  })), _react["default"].createElement(_reactNative.View, {
    style: styles.videoView,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 155,
      columnNumber: 9
    }
  }, _react["default"].createElement(_icons.Recorder, {
    height: 20,
    pathFill: white,
    width: 25,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 156,
      columnNumber: 11
    }
  }), videoDuration ? _react["default"].createElement(_reactNative.Text, {
    style: [styles.durationText, durationText, {
      color: white
    }],
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 158,
      columnNumber: 13
    }
  }, durationLabel) : null)));
};

var AttachmentImage = function AttachmentImage(props) {
  var asset = props.asset,
      ImageOverlaySelectedComponent = props.ImageOverlaySelectedComponent,
      maxNumberOfFiles = props.maxNumberOfFiles,
      numberOfAttachmentPickerImageColumns = props.numberOfAttachmentPickerImageColumns,
      numberOfUploads = props.numberOfUploads,
      selected = props.selected,
      setSelectedImages = props.setSelectedImages;

  var _useTheme2 = (0, _ThemeContext.useTheme)(),
      _useTheme2$theme = _useTheme2.theme,
      _useTheme2$theme$atta = _useTheme2$theme.attachmentPicker,
      image = _useTheme2$theme$atta.image,
      imageOverlay = _useTheme2$theme$atta.imageOverlay,
      overlay = _useTheme2$theme.colors.overlay;

  var size = (0, _utils.vw)(100) / (numberOfAttachmentPickerImageColumns || 3) - 2;
  var uri = asset.uri;

  var onPressImage = function onPressImage() {
    if (selected) {
      setSelectedImages(function (images) {
        return images.filter(function (image) {
          return image.uri !== asset.uri;
        });
      });
    } else {
      setSelectedImages(function (images) {
        if (numberOfUploads >= maxNumberOfFiles) {
          _reactNative.Alert.alert('Maximum number of files reached');

          return images;
        }

        return [].concat((0, _toConsumableArray2["default"])(images), [asset]);
      });
    }
  };

  return _react["default"].createElement(_bottomSheet.TouchableOpacity, {
    onPress: onPressImage,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 204,
      columnNumber: 5
    }
  }, _react["default"].createElement(_reactNative.ImageBackground, {
    source: {
      uri: uri
    },
    style: [{
      height: size,
      margin: 1,
      width: size
    }, image],
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 205,
      columnNumber: 7
    }
  }, selected && _react["default"].createElement(_reactNative.View, {
    style: [styles.overlay, {
      backgroundColor: overlay
    }, imageOverlay],
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 217,
      columnNumber: 11
    }
  }, _react["default"].createElement(ImageOverlaySelectedComponent, {
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 218,
      columnNumber: 13
    }
  }))));
};

var renderItem = function renderItem(_ref2) {
  var item = _ref2.item;
  var asset = item.asset,
      ImageOverlaySelectedComponent = item.ImageOverlaySelectedComponent,
      maxNumberOfFiles = item.maxNumberOfFiles,
      numberOfAttachmentPickerImageColumns = item.numberOfAttachmentPickerImageColumns,
      numberOfUploads = item.numberOfUploads,
      selected = item.selected,
      setSelectedFiles = item.setSelectedFiles,
      setSelectedImages = item.setSelectedImages;
  var contentType = (0, _mimeTypes.lookup)(asset.filename) || 'multipart/form-data';
  var fileType = asset.filename ? contentType.startsWith('image/') ? 'image' : 'video' : asset.type === 'video' ? 'video' : 'image';
  return fileType === 'image' ? _react["default"].createElement(AttachmentImage, {
    asset: asset,
    ImageOverlaySelectedComponent: ImageOverlaySelectedComponent,
    maxNumberOfFiles: maxNumberOfFiles,
    numberOfAttachmentPickerImageColumns: numberOfAttachmentPickerImageColumns,
    numberOfUploads: numberOfUploads,
    selected: selected,
    setSelectedImages: setSelectedImages,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 249,
      columnNumber: 5
    }
  }) : _react["default"].createElement(AttachmentVideo, {
    asset: asset,
    ImageOverlaySelectedComponent: ImageOverlaySelectedComponent,
    maxNumberOfFiles: maxNumberOfFiles,
    numberOfAttachmentPickerImageColumns: numberOfAttachmentPickerImageColumns,
    numberOfUploads: numberOfUploads,
    selected: selected,
    setSelectedFiles: setSelectedFiles,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 259,
      columnNumber: 5
    }
  });
};

var AttachmentPicker = _react["default"].forwardRef(function (props, ref) {
  var _StatusBar$currentHei, _StatusBar$currentHei2;

  var AttachmentPickerBottomSheetHandle = props.AttachmentPickerBottomSheetHandle,
      attachmentPickerBottomSheetHandleHeight = props.attachmentPickerBottomSheetHandleHeight,
      attachmentPickerBottomSheetHeight = props.attachmentPickerBottomSheetHeight,
      AttachmentPickerError = props.AttachmentPickerError,
      attachmentPickerErrorButtonText = props.attachmentPickerErrorButtonText,
      AttachmentPickerErrorImage = props.AttachmentPickerErrorImage,
      attachmentPickerErrorText = props.attachmentPickerErrorText,
      ImageOverlaySelectedComponent = props.ImageOverlaySelectedComponent,
      numberOfAttachmentImagesToLoadPerCall = props.numberOfAttachmentImagesToLoadPerCall,
      numberOfAttachmentPickerImageColumns = props.numberOfAttachmentPickerImageColumns,
      translucentStatusBar = props.translucentStatusBar;

  var _useTheme3 = (0, _ThemeContext.useTheme)(),
      _useTheme3$theme = _useTheme3.theme,
      bottomSheetContentContainer = _useTheme3$theme.attachmentPicker.bottomSheetContentContainer,
      white = _useTheme3$theme.colors.white;

  var _useAttachmentPickerC = (0, _AttachmentPickerContext.useAttachmentPickerContext)(),
      closePicker = _useAttachmentPickerC.closePicker,
      maxNumberOfFiles = _useAttachmentPickerC.maxNumberOfFiles,
      selectedFiles = _useAttachmentPickerC.selectedFiles,
      selectedImages = _useAttachmentPickerC.selectedImages,
      selectedPicker = _useAttachmentPickerC.selectedPicker,
      setSelectedFiles = _useAttachmentPickerC.setSelectedFiles,
      setSelectedImages = _useAttachmentPickerC.setSelectedImages,
      setSelectedPicker = _useAttachmentPickerC.setSelectedPicker,
      topInset = _useAttachmentPickerC.topInset;

  var _useState = (0, _react.useState)(-1),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      currentIndex = _useState2[0],
      setCurrentIndex = _useState2[1];

  var _useState3 = (0, _react.useState)(),
      _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
      endCursor = _useState4[0],
      setEndCursor = _useState4[1];

  var _useState5 = (0, _react.useState)(false),
      _useState6 = (0, _slicedToArray2["default"])(_useState5, 2),
      photoError = _useState6[0],
      setPhotoError = _useState6[1];

  var _useState7 = (0, _react.useState)(true),
      _useState8 = (0, _slicedToArray2["default"])(_useState7, 2),
      hasNextPage = _useState8[0],
      setHasNextPage = _useState8[1];

  var _useState9 = (0, _react.useState)(false),
      _useState10 = (0, _slicedToArray2["default"])(_useState9, 2),
      loadingPhotos = _useState10[0],
      setLoadingPhotos = _useState10[1];

  var _useState11 = (0, _react.useState)([]),
      _useState12 = (0, _slicedToArray2["default"])(_useState11, 2),
      photos = _useState12[0],
      setPhotos = _useState12[1];

  var bottomSheetCloseOnKeyboardShowTimeout = (0, _react.useRef)();

  var getMorePhotos = function () {
    var _ref3 = (0, _asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2() {
      var results;
      return _regenerator["default"].wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              if (!(hasNextPage && !loadingPhotos && currentIndex > -1 && selectedPicker === 'images')) {
                _context2.next = 16;
                break;
              }

              setLoadingPhotos(true);
              _context2.prev = 2;
              _context2.next = 5;
              return (0, _native.getPhotos)({
                after: endCursor,
                first: numberOfAttachmentImagesToLoadPerCall != null ? numberOfAttachmentImagesToLoadPerCall : 60
              });

            case 5:
              results = _context2.sent;

              if (endCursor) {
                setPhotos([].concat((0, _toConsumableArray2["default"])(photos), (0, _toConsumableArray2["default"])(results.assets)));
              } else {
                setPhotos(results.assets);
              }

              setEndCursor(results.endCursor);
              setHasNextPage(results.hasNextPage || false);
              _context2.next = 15;
              break;

            case 11:
              _context2.prev = 11;
              _context2.t0 = _context2["catch"](2);
              console.log(_context2.t0);
              setPhotoError(true);

            case 15:
              setLoadingPhotos(false);

            case 16:
            case "end":
              return _context2.stop();
          }
        }
      }, _callee2, null, [[2, 11]]);
    }));

    return function getMorePhotos() {
      return _ref3.apply(this, arguments);
    };
  }();

  (0, _react.useEffect)(function () {
    var backAction = function backAction() {
      if (selectedPicker) {
        setSelectedPicker(undefined);
        closePicker();
        return true;
      }

      return false;
    };

    var backHandler = _reactNative.BackHandler.addEventListener('hardwareBackPress', backAction);

    return function () {
      return backHandler.remove();
    };
  }, [selectedPicker]);
  (0, _react.useEffect)(function () {
    var hideAttachmentPicker = function hideAttachmentPicker() {
      if (bottomSheetCloseOnKeyboardShowTimeout.current) {
        clearTimeout(bottomSheetCloseOnKeyboardShowTimeout.current);
      }

      setSelectedPicker(undefined);
      bottomSheetCloseOnKeyboardShowTimeout.current = setTimeout(function () {
        var _current;

        return (_current = ref.current) == null ? void 0 : _current.close();
      }, 150);
    };

    var keyboardSubscription = _reactNative.Platform.OS === 'ios' ? _reactNative.Keyboard.addListener('keyboardWillShow', hideAttachmentPicker) : _reactNative.Keyboard.addListener('keyboardDidShow', hideAttachmentPicker);
    return function () {
      if (keyboardSubscription != null && keyboardSubscription.remove) {
        keyboardSubscription.remove();
        return;
      }

      if (_reactNative.Platform.OS === 'ios') {
        _reactNative.Keyboard.removeListener('keyboardWillShow', hideAttachmentPicker);
      } else {
        _reactNative.Keyboard.removeListener('keyboardDidShow', hideAttachmentPicker);
      }

      if (bottomSheetCloseOnKeyboardShowTimeout.current) {
        clearTimeout(bottomSheetCloseOnKeyboardShowTimeout.current);
      }
    };
  }, []);
  (0, _react.useEffect)(function () {
    if (currentIndex < 0) {
      setSelectedPicker(undefined);

      if (!loadingPhotos) {
        setEndCursor(undefined);
        setHasNextPage(true);
      }
    }
  }, [currentIndex]);
  (0, _react.useEffect)(function () {
    if (selectedPicker === 'images' && endCursor === undefined && currentIndex > -1 && !loadingPhotos) {
      setPhotoError(false);
      getMorePhotos();
    }
  }, [currentIndex, selectedPicker]);
  var selectedPhotos = photos.map(function (asset) {
    return {
      asset: asset,
      ImageOverlaySelectedComponent: ImageOverlaySelectedComponent,
      maxNumberOfFiles: maxNumberOfFiles,
      numberOfAttachmentPickerImageColumns: numberOfAttachmentPickerImageColumns,
      numberOfUploads: selectedFiles.length + selectedImages.length,
      selected: selectedImages.some(function (image) {
        return image.uri === asset.uri;
      }) || selectedFiles.some(function (file) {
        return file.uri === asset.uri;
      }),
      setSelectedFiles: setSelectedFiles,
      setSelectedImages: setSelectedImages
    };
  });
  var handleHeight = attachmentPickerBottomSheetHandleHeight || 20;
  var statusBarHeight = (_StatusBar$currentHei = _reactNative.StatusBar.currentHeight) != null ? _StatusBar$currentHei : 0;
  var bottomBarHeight = fullScreenHeight - screenHeight - statusBarHeight;
  var androidBottomBarHeightAdjustment = _reactNative.Platform.OS === 'android' ? bottomBarHeight === statusBarHeight ? translucentStatusBar ? 0 : (_StatusBar$currentHei2 = _reactNative.StatusBar.currentHeight) != null ? _StatusBar$currentHei2 : 0 : translucentStatusBar ? bottomBarHeight > statusBarHeight ? -bottomBarHeight + statusBarHeight : bottomBarHeight > 0 ? -statusBarHeight : 0 : bottomBarHeight > 0 ? 0 : statusBarHeight : 0;
  var initialSnapPoint = (attachmentPickerBottomSheetHeight != null ? attachmentPickerBottomSheetHeight : _reactNative.Platform.OS === 'android') ? 308 + (fullScreenHeight - screenHeight + androidBottomBarHeightAdjustment) - handleHeight : 308 + (fullScreenHeight - screenHeight + androidBottomBarHeightAdjustment);
  var finalSnapPoint = _reactNative.Platform.OS === 'android' ? fullScreenHeight - topInset - handleHeight : fullScreenHeight - topInset;
  var snapPoints = (0, _react.useMemo)(function () {
    return [initialSnapPoint, finalSnapPoint];
  }, [initialSnapPoint, finalSnapPoint]);
  return _react["default"].createElement(_react["default"].Fragment, null, _react["default"].createElement(_bottomSheet["default"], {
    containerHeight: fullScreenHeight,
    enablePanDownToClose: true,
    handleComponent: photoError ? null : AttachmentPickerBottomSheetHandle,
    handleHeight: handleHeight,
    index: -1,
    onChange: setCurrentIndex,
    ref: ref,
    snapPoints: snapPoints,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 507,
      columnNumber: 9
    }
  }, _react["default"].createElement(_bottomSheet.BottomSheetFlatList, {
    contentContainerStyle: [styles.container, {
      backgroundColor: white
    }, bottomSheetContentContainer, {
      opacity: photoError ? 0 : 1
    }],
    data: selectedPhotos,
    keyExtractor: function keyExtractor(item) {
      return item.asset.uri;
    },
    numColumns: numberOfAttachmentPickerImageColumns != null ? numberOfAttachmentPickerImageColumns : 3,
    onEndReached: getMorePhotos,
    renderItem: renderItem,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 523,
      columnNumber: 11
    }
  })), selectedPicker === 'images' && photoError && _react["default"].createElement(AttachmentPickerError, {
    attachmentPickerBottomSheetHeight: attachmentPickerBottomSheetHeight,
    attachmentPickerErrorButtonText: attachmentPickerErrorButtonText,
    AttachmentPickerErrorImage: AttachmentPickerErrorImage,
    attachmentPickerErrorText: attachmentPickerErrorText,
    __self: _this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 538,
      columnNumber: 11
    }
  }));
});

exports.AttachmentPicker = AttachmentPicker;
AttachmentPicker.displayName = 'AttachmentPicker';
//# sourceMappingURL=AttachmentPicker.js.map